# ISAIチャットボット - 現状の仕様とネクストアクション

## 実装済み機能

### 1. マルチプラットフォーム対応
- ✅ Chatwork Bot連携（DM対応）
- ✅ LINE Messaging API連携
- ✅ コースごとに独立したボット設定

### 2. 教材管理
- ✅ PDF教材のアップロード・解析・ベクトル化
- ✅ Excel/CSVファイルのアップロード・解析・ベクトル化
- ✅ Googleスプレッドシートのリアルタイム連携
- ✅ 管理画面での教材管理UI

### 3. AI回答生成
- ✅ 教材内容を参照したRAG（Retrieval-Augmented Generation）
- ✅ 教材がない場合の一般的な知識での回答
- ✅ 会話履歴の保持
- ✅ 画像メッセージの解析（LINE対応）

### 4. ポーリング方式（1000人以上対応）
- ✅ ChatworkのWebhook制限（5件）を回避
- ✅ 30秒ごとに全DMルームの未読メッセージを自動取得
- ✅ 処理済みメッセージの重複防止
- ✅ レート制限（300リクエスト/5分）を考慮した実装

### 5. 満足度判定と二次回答フロー
- ✅ ユーザーのメッセージ内容から自動で満足度を判定
- ✅ 不満がある場合、Slackで運営スタッフに通知
- ✅ 同じ質問の繰り返しを検出

### 6. 会話記録
- ✅ Googleスプレッドシートへの自動記録
- ✅ 質問・回答・満足度の記録
- ✅ 手動フィードバック用の列

### 7. 管理画面
- ✅ コース管理
- ✅ 教材管理（PDF、Excel、CSV、スプレッドシート）
- ✅ 会話履歴の閲覧
- ✅ JWT認証

## 現在の課題とネクストアクション

### 課題1: マイチャット対応の動作確認
**現状**: マイチャット（自分自身とのチャット）対応の実装は完了しているが、動作確認が必要

**ネクストアクション**:
1. サーバーを再起動
2. マイチャットにメッセージを送信して動作確認
3. ログファイル（`.cursor/debug.log`）で動作を確認

### 課題2: DM返信が来ない問題の調査
**現状**: 個人アカウントからISAI事務局アカウントにDMを送信しても返信が来ない

**ネクストアクション**:
1. サーバーを再起動してポーリングタスクが開始されているか確認
2. `.env`ファイルに`CHATWORK_API_TOKEN_{course_id}`が正しく設定されているか確認
3. コースが登録されているか、プラットフォームが"chatwork"に設定されているか確認
4. ログファイルで以下を確認：
   - ポーリングが開始されているか
   - コースが検出されているか
   - ルームが検出されているか
   - メッセージが取得されているか
   - 質問判定の結果
   - メッセージ送信の結果

### 課題3: デバッグログの整理
**現状**: デバッグ用のログが追加されている

**ネクストアクション**:
1. 問題が解決したら、デバッグログを削除または条件付きログに変更
2. 本番環境では不要なログを出力しないようにする

## 技術仕様

### ポーリング方式の詳細
- **間隔**: 30秒ごと
- **対象**: 全DMルーム（type="my"で2人のみのルーム、またはマイチャット）
- **処理**: 未読メッセージを取得 → 質問判定 → AI回答生成 → 送信 → 既読マーク
- **レート制限**: 300リクエスト/5分（各リクエスト間に1秒の待機）

### Chatwork API制約
- **Webhook制限**: 1アカウントあたり最大5件（有料プランでも同じ）
- **レート制限**: 300リクエスト/5分（有料プランでも同じ）
- **DMルーム**: メンバーが2人のルーム（type="my"）
- **マイチャット**: メンバーが1人のルーム（自分自身のみ）

### データ保存場所
- **コース設定**: `backend/data/config.json`
- **ユーザー情報**: `backend/data/users.json`
- **PDF/Excel/CSV**: `backend/data/pdfs/`, `backend/data/excel/`, `backend/data/csv/`
- **ベクトルデータ**: `backend/data/vectors/`
- **会話履歴**: `backend/data/conversations/`

## サーバー起動・再起動方法

### 起動方法
```bash
cd online-school-bot/backend
python3 main.py
```

または起動スクリプトを使用：
```bash
cd online-school-bot
./start.sh
```

### 停止方法
- ターミナルで `Ctrl + C` を押す
- または、バックグラウンドで実行している場合は：
  ```bash
  ps aux | grep "python.*main.py"
  kill <プロセスID>
  ```

## 設定確認方法

### コース設定の確認
1. 管理画面で確認: `http://localhost:8002` → ログイン → 「コース管理」タブ
2. 設定ファイルで確認: `online-school-bot/backend/data/config.json`
   - `"platform": "chatwork"` が設定されているか確認

### APIトークンの確認
- `.env`ファイルに`CHATWORK_API_TOKEN_{course_id}`が設定されているか確認
- 例: `CHATWORK_API_TOKEN_001=xxx`

## 次のステップ

1. **動作確認**
   - サーバーを再起動
   - 個人アカウントからISAI事務局アカウントにDMを送信
   - ログファイルで動作を確認

2. **問題解決**
   - ログファイルを分析して原因を特定
   - 必要に応じて修正

3. **本番環境への準備**
   - デバッグログの整理
   - エラーハンドリングの強化
   - パフォーマンス最適化
